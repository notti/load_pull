%
\documentclass[11pt]{article}
\usepackage{register}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[pdf]{pstricks}
\usepackage{pst-circ}
\begin{document}

\title{}
\author{Gernot Vormayr}
\date{}
\maketitle
blah
\begin{register}{htbp}{reg(0)}{0x00}%
\label{reg0}%
\regfield{rec\_rst}{1}{31}{0}%
\regfield{Reserved}{4}{27}{0}%
\regfield{rec\_stream\_valid}{1}{26}{0}%
\regfield{rec\_input\_select}{2}{24}{0}%
\regfield{Reserved}{2}{22}{0}%
\regfield{rec\_data\_valid(3)}{1}{21}{0}%
\regfield{rec\_rxeqmix(3)}{2}{19}{0}%
\regfield{rec\_descramble(3)}{1}{18}{1}%
\regfield{rec\_polarity(3)}{1}{17}{1}%
\regfield{rec\_enable(3)}{1}{16}{1}%
\regfield{Reserved}{2}{14}{0}%
\regfield{rec\_data\_valid(1)}{1}{13}{0}%
\regfield{rec\_rxeqmix(1)}{2}{11}{0}%
\regfield{rec\_descramble(1)}{1}{10}{1}%
\regfield{rec\_polarity(1)}{1}{9}{1}%
\regfield{rec\_enable(1)}{1}{8}{1}%
\regfield{Reserved}{2}{6}{0}%
\regfield{rec\_data\_valid(0)}{1}{5}{0}%
\regfield{rec\_rxeqmix(0)}{2}{3}{0}%
\regfield{rec\_descramble(0)}{1}{2}{1}%
\regfield{rec\_polarity(0)}{1}{1}{1}%
\regfield{rec\_enable(0)}{1}{0}{1}%
\reglabel{Reset}\regnewline%
\end{register}
\begin{register}{htbp}{reg(1)}{0x04}%
\label{reg1}%
\regfield{avg\_rst}{1}{31}{0}%
\regfield{Reserved}{3}{28}{0}%
\regfield{avg\_err}{1}{27}{0}%
\regfield{avg\_active}{1}{26}{0}%
\regfield{avg\_width}{2}{24}{0}%
\regfield{trig\_rst}{1}{23}{0}%
\regfield{Reserved}{3}{19}{0}%
\regfield{trig\_int}{1}{19}{0}%
\regfield{trig\_arm}{1}{18}{0}%
\regfield{Reserved}{1}{17}{0}%
\regfield{trig\_type}{1}{16}{0}%
\regfield{depth}{16}{0}{0}%
\reglabel{Reset}\regnewline%
\end{register}
\begin{register}{htbp}{reg(2)}{0x08}%
\label{reg2}%
\regfield{Reserved}{4}{28}{0}%
\regfield{core\_scale\_schi}{12}{16}{0}%
\regfield{Reserved}{4}{12}{0}%
\regfield{core\_scale\_sch}{12}{0}{0}%
\reglabel{Reset}\regnewline%
\end{register}
\begin{register}{htbp}{reg(3)}{0x0C}%
\label{reg3}%
\regfield{core\_rst}{1}{31}{0}%
\regfield{Reserved}{2}{29}{0}%
\regfield{core\_ov\_cmul}{1}{28}{0}%
\regfield{core\_ov\_ifft}{1}{27}{0}%
\regfield{core\_ov\_fft}{1}{26}{0}%
\regfield{core\_start}{1}{25}{0}%
\regfield{core\_iq}{1}{24}{0}%
\regfield{Reserved}{3}{21}{0}%
\regfield{core\_n}{5}{16}{0}%
\regfield{core\_cmul\_sch}{2}{14}{0}%
\regfield{Reserved}{2}{12}{0}%
\regfield{core\_L}{12}{0}{0}%
\reglabel{Reset}\regnewline%
\end{register}
\begin{register}{htbp}{reg(4)}{0x10}%
\label{reg4}%
\regfield{tx\_mulq}{16}{16}{0}%
\regfield{tx\_muli}{16}{0}{0}%
\reglabel{Reset}\regnewline%
\end{register}
\begin{register}{htbp}{reg(5)}{0x14}%
\label{reg5}%
\regfield{tx\_shift}{1}{31}{0}%
\regfield{tx\_ovfl}{1}{30}{0}%
\regfield{Reserved}{5}{25}{0}%
\regfield{mem\_req}{1}{24}{0}%
\regfield{tx\_rst}{1}{23}{0}%
\regfield{Reserved}{3}{20}{0}%
\regfield{tx\_resync}{1}{19}{0}%
\regfield{tx\_toggle}{1}{18}{0}%
\regfield{tx\_dc\_balance}{1}{17}{0}%
\regfield{tx\_deskew}{1}{16}{0}%
\regfield{tx\_frame\_offset}{16}{0}{0}%
\reglabel{Reset}\regnewline%
\end{register}

\begin{pspicture}[showgrid](0,0)(10,10)
\SpecialCoor
\rput(0,8.4)
{
    \psframe(0,0)(10.2,5.3)
    \rput[tr](10,5.2){inbuf}
    \pnode(0,0.2){inbufCtrl}
    \pnode(0,4.15){inbufDataIn}
    \pnode(0,2.85){inbufDataOut}
    \pnode(3.9,2){inbufDataMux}
    \pnode(1.9,1.4){averageMemCtrl}
    \rput(0,1.4)
    {
        \rput[tr](3.4,3.3){average\_mem}
        \psframe(0.2,0)(3.5,3.4)
        \rput(0.6,0.4)
        {
            \rput(1.7,1.7){\rnode{inMem}{\psframebox[fillstyle=solid]{mem}}}
            \rput[t](2,1){\circlenode{inAdd}{$+$}}
            \pnode(! \psGetNodeCenter{inAdd} 2.5 inAdd.y 0.25 add){averageAddLoop}
            \pnode(! \psGetNodeCenter{inAdd} 2.5 inAdd.y 0.25 sub){averageAddIn}
            \pnode(1,0.5){averageMuxOut}
            \pnode(2.5,0.2){averageDataSplit}
            \pnode(! \psGetNodeCenter{inAdd} 1.2 inAdd.y){averageMuxInAdd}
            \pnode(1.2,0.2){averageMuxInData}
            \ncline[linecolor=blue]{inAdd}{averageAddIn}
            \ncline[linecolor=blue]{inAdd}{averageMuxInAdd}
            \ncline[linecolor=green]{inAdd}{averageAddLoop}
            \ncangle[linecolor=green, angleA=90, angleB=-90, offsetB=-1pt]{averageAddLoop}{inMem}
            \ncloop[linecolor=green, armA=0.2, angleA=90, offsetA=1pt, angleB=180, loopsize=-1]{inMem}{averageMuxOut}
            \ncline[linecolor=blue]{averageAddIn}{averageDataSplit}
            \ncline[linecolor=blue]{averageDataSplit}{averageMuxInData}
            \psdot[linecolor=blue](averageDataSplit)
            \pnode(0.1,1.05){inMuxOut}
            \pnode(0.1,2.35){inMuxIn}
            \ncangle[linecolor=green, angleB=-90, offsetB=1pt, armB=0]{inMuxOut}{inMem}
            \ncangle[linecolor=green, angleB=90, offsetB=1pt, armB=0]{inMuxIn}{inMem}
            \ncline[linecolor=green]{inMuxOut}{inbufDataOut}
            \ncline[linecolor=green]{inMuxIn}{inbufDataIn}
            \rput(1,0){\pspolygon[fillcolor=white,fillstyle=solid](0,0.15)(0.2,0)(0.2,1)(0,0.85)}
            \rput(0,0.7){\pspolygon[fillcolor=white,fillstyle=solid](0,0.15)(0.2,0)(0.2,0.7)(0,0.55)}
            \rput{180}(0.2,2.7){\pspolygon[fillcolor=white,fillstyle=solid](0,0.15)(0.2,0)(0.2,0.7)(0,0.55)}
        }
    }
    \rput(4.2,2)
    {
        \psframe(0,-0.6)(5.8,0.9)
        \rput[tr](5.7,0.8){receiver}
        \multido{\i=2+-1,\n=0.1+-0.1}{3}
        {
            \rput(\n,\n)
            {
                {
                    \psset{fillstyle=solid}
                    \rput[l](0.3,0){\rnode{descramble\i}{\psframebox{descramble}}}
                    \rput(3.5,0){\rnode{GTX\i}{\psframebox{GTX}}}
                    \rput(5,0){\rnode{align\i}{\psframebox{align}}}
                }
                \pnode(!\n\space neg -0.2 add 0){inbufDataMUX\i}
                \ncline[linecolor=blue]{GTX\i}{descramble\i}
                \ncline[linecolor=blue]{descramble\i}{inbufDataMUX\i}
                \psset{linecolor=red}
                \ncline{align\i}{GTX\i}
                \ncangle[angleA=-90, armB=0]{align\i}{inbufCtrl}
                \ncangle[angleA=-90, armB=0]{GTX\i}{inbufCtrl}
                \ncangle[angleA=-90, armB=0]{descramble\i}{inbufCtrl}
            }
        }
    }
    {
        \psset{fillstyle=solid}
        \rput[l](2.1,0.7){\rnode{wallclk}{\psframebox{wallclk}}}
        \rput[r](1.6,0.7){\rnode{trigger}{\psframebox{trigger}}}
    }
    \ncline[linecolor=blue]{inbufDataMux}{averageDataSplit}
    {
        \psset{linecolor=red}
        \ncangle[angleA=-90, angleB=180, armB=0, offsetA=2pt]{averageMemCtrl}{wallclk}
        \ncangle[angleA=-90, armB=0, offsetA=-2pt]{averageMemCtrl}{trigger}
        \ncangle[angleA=-90, armB=0]{averageMemCtrl}{inbufCtrl}
        \ncangle[angleA=-90, armB=0]{trigger}{inbufCtrl}
        \ncangle[angleA=-90, armB=0]{wallclk}{inbufCtrl}
        \ncangle[angleA=-90, armB=0]{inbufDataMux}{inbufCtrl}
    }
    \rput(3.8,1.65){\pspolygon[fillcolor=white,fillstyle=solid](0,0.15)(0.2,0)(0.2,0.7)(0,0.55)}
}
{
    \rput[tr](7.4,8.1){core}
    \psframe(0,0)(7.5,8.2)
    \rput(2,0.2)
    {
        \rput[tr](5.2,7.4){overlap\_add}
        \psframe(0,0)(5.3,7.5)
        \rput(3,3.2)
        {
            \rput[tr](2,3.5){fftncmul}
            \psframe(0,0)(2.1,3.6)
            \rput(1,2.5){\rnode{wave}{\psframebox[fillstyle=solid]{wave}}}
            \rput(1,1){\circlenode[fillstyle=solid]{fftncmulMul}{$\times$}}
            \pnode(! \psGetNodeCenter{fftncmulMul} fftncmulMul.x 0.25 sub fftncmulMul.y 0.5 add){fftncmulMulA}
            \pnode(! \psGetNodeCenter{fftncmulMul} fftncmulMul.x 0.25 add fftncmulMul.y 0.5 add){fftncmulMulB}
            \ncline[linecolor=blue]{fftncmulMul}{fftncmulMulA}
            \ncline[linecolor=green]{fftncmulMul}{fftncmulMulB}
            \pnode(1.05,0){fftncmulCtrl}
        }
        \rput(3,0.2)
        {
            \rput[tr](2,2.5){ifftnadd}
            \psframe(0,0)(2.1,2.6)
            \rput(1,1){\circlenode[fillstyle=solid]{ifftnaddAdd}{$+$}}
            \pnode(! \psGetNodeCenter{ifftnaddAdd} ifftnaddAdd.x 0.25 sub ifftnaddAdd.y 0.5 add){ifftnaddAddA}
            \pnode(! \psGetNodeCenter{ifftnaddAdd} ifftnaddAdd.x 0.25 add ifftnaddAdd.y 0.5 add){ifftnaddAddB}
            \ncline[linecolor=blue]{ifftnaddAdd}{ifftnaddAddA}
            \ncline[linecolor=green]{ifftnaddAdd}{ifftnaddAddB}
            \pnode(1.05,2.6){ifftnaddCtrl}
        }
        \rput(2.4,3){\rnode{fft}{\psframebox{fft}}}
        \rput[l](0.2,2.5){\rnode{scratch}{\psframebox{scratch}}}
        \pnode(! \psGetNodeCenter{ifftnaddAdd} 3.2 ifftnaddAdd.y 0.5 0.2 add add){fftOutSplit}
        \psdot[linecolor=blue](fftOutSplit)
        \ncangle[linecolor=blue, angleA=-90, angleB=180, armB=0.2]{fft}{fftOutSplit}
        \ncangle[linecolor=blue, angleA=-90, angleB=90, armB=0.2]{fftOutSplit}{fftncmulMulA}
        \ncangle[linecolor=blue, angleA=-90, angleB=90, armB=0.2]{fftOutSplit}{ifftnaddAddA}
        \pnode(2.9,3){fftCtrlSplit}
        \pnode(2.4,4.1){fftMux}
        \ncangle[linecolor=red, angleB=-90, armB=0]{fftCtrlSplit}{fftncmulCtrl}
        \ncangle[linecolor=red, angleB=90, armB=0]{fftCtrlSplit}{ifftnaddCtrl}
        \ncangle[linecolor=red, angleA=90]{fftCtrlSplit}{fftMux}
        \ncline[linecolor=red]{fft}{fftCtrlSplit}
        \ncangle[linecolor=green, angleA=90, angleB=-90]{scratch}{fftncmulMul}
        \ncangle[linecolor=blue, angleA=-90, angleB=90, offsetB=0.15, armB=1.2]{wave}{fftMux}
        \ncline[linecolor=blue]{fftMux}{fft}
        \pnode(1.85,2.05){scratchSplit}
        \ncangle[linecolor=green, angleA=-90, angleB=180]{scratch}{scratchSplit}
        \ncangle[linecolor=green, angleA=90, angleB=90, offsetB=-0.15]{scratchSplit}{fftMux}
        \psdot[linecolor=green](scratchSplit)
        \ncangle[linecolor=green, angleB=90]{scratchSplit}{ifftnaddAddB}
        \rput{90}(2.75,4){\pspolygon[fillcolor=white,fillstyle=solid](0,0.15)(0.2,0)(0.2,0.7)(0,0.55)}
    }
    \rput(1,5.7){\rnode{H}{\psframebox{H}}}
    \ncangle[linecolor=green, angleA=-90, angleB=90, offsetA=1pt]{H}{fftncmulMulB}
    \pnode(0,7){coreCtrl}
    \pnode(2,7){overlapAddCtrl}
    \pnode(0,6.4){coreIn}
    \pnode(0,6.2){coreHIn}
    \pnode(0,5.25){coreHOut}
    \pnode(0,0.6){coreOut}
    \ncline[linecolor=red]{coreCtrl}{overlapAddCtrl}
    \ncangle[linecolor=green, angleB=90, armB=0]{coreIn}{wave}
    \ncangle[linecolor=green, angleB=90, armB=0]{coreHIn}{H}
    \ncangle[linecolor=green, angleB=-90, armB=0, offsetB=1pt]{coreHOut}{H}
    \ncangle[linecolor=green, angleB=-90, armB=0]{coreOut}{ifftnaddAdd}
}
%outbuf
% mem
% mem
% mux
% cmul
% transmitter
%  balance
\end{pspicture}
\end{document}
