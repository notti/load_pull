\documentclass{beamer}
\usepackage{etex}

\title[FPGA based LP]{Diploma thesis}
\author[G.~Vormayr]{Gernot Vormayr\\0425210}
\institute[EMCE]{Institute of Electrodynamics, Microwave and Circuit Engineering}
\date[MW '15]{Microwave Engineering 2015}
\subtitle{FPGA based Load-Pull Measurement System}

\mode<presentation>
{
    \usetheme{CambridgeUS}
    \usecolortheme{dolphin} %whale?
    \usefonttheme{structureitalicserif}
    \setbeamertemplate{navigation symbols}{}
}

\AtBeginSubsection[]
{
  \begin{frame}<beamer>{Outline}
    \tableofcontents[currentsection,currentsubsection]
  \end{frame}
}
\usepackage[overlay,absolute]{textpos}
\usepackage[english]{babel}

%drawings

\usepackage{graphicx}
\graphicspath{{images/}}
\usepackage{tikz}
\usepackage{circuitikz}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{arrows}
\usetikzlibrary{backgrounds}
\usetikzlibrary{bending}
\usetikzlibrary{calc}
\usetikzlibrary{colorbrewer}
\usetikzlibrary{chains}
\usetikzlibrary{circuits.ee.IEC}
\usetikzlibrary{decorations.pathmorphing}
\usetikzlibrary{dsp}
\usetikzlibrary{fit}
\usetikzlibrary{matrix}
\usetikzlibrary{patterns}
\usetikzlibrary{positioning}
\usetikzlibrary{scopes}
\usetikzlibrary{shadows}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{shapes.misc}
\usepackage{tikz-timing}
\include{rfsymbols}
\makeatletter
\newcommand\currentcoordinate{\the\tikz@lastxsaved,\the\tikz@lastysaved}
\makeatother

\tikzset{
    invisible/.style={opacity=0,text opacity=0},
    visible on/.style={alt=<#1>{}{invisible}},
    alt/.code args={<#1>#2#3}{%
        \alt<#1>{\pgfkeysalso{#2}}{\pgfkeysalso{#3}}
    },
    alert/.style={alt=<#1>{red!85!black}{}},
    Alert/.style={alt=#1{red!85!black}{}}
}

%units

\usepackage[binary-units,retain-explicit-plus]{siunitx}
\DeclareSIUnit \belm {Bm}
\DeclareSIUnit \belfs {BFS}
\DeclareSIUnit \samples {S}
\sisetup{per-mode = symbol}

%plots

\usepackage{pgfplots}
\pgfplotsset{compat=1.12}
\pgfplotsset{every axis/.append style={grid=major,legend style={font=\footnotesize}}}
\usepgfplotslibrary{smithchart}
\usepgfplotslibrary{units}
\usepgfplotslibrary{fillbetween}
\usepgfplotslibrary{statistics}
\usepgfplotslibrary{colorbrewer}
\pgfplotsset{unit code/.code 2 args={\si{#1#2}}}

\usepgfplotslibrary{external}
\tikzsetexternalprefix{figures/}
\tikzexternalize[mode=list and make]
\tikzexternalwritetomakefile{}
\tikzexternalwritetomakefile{.DELETE_ON_ERROR:}
\tikzexternalwritetomakefile{}

%math

\usepackage{gensymb}

\providecommand{\abs}[1]{\lvert#1\rvert}

%source

\usepackage{listings}
\lstset{language=Matlab,numbers=left,numberstyle=\tiny,stepnumber=5,numbersep=5pt,frame=single,
breaklines=true,postbreak=\raisebox{0ex}[0ex][0ex]{\ensuremath{\color{red}\hookrightarrow\space}},
captionpos=b,escapeinside={(*}{*)},mathescape=true}
\usepackage{letltxmacro}
\newcommand*{\SavedLstInline}{}
\LetLtxMacro\SavedLstInline\lstinline
\DeclareRobustCommand*{\lstinline}{%
  \ifmmode
    \let\SavedBGroup\bgroup
    \def\bgroup{%
      \let\bgroup\SavedBGroup
      \hbox\bgroup
    }%
  \fi
  \SavedLstInline
}

%stuff

\usepackage{url}
\usepackage{booktabs} % nicer tables

\def\device#1{\textit{#1}}


\newcommand{\backupbegin}{
   \newcounter{framenumberappendix}
   \setcounter{framenumberappendix}{\value{framenumber}}
}
\newcommand{\backupend}{
   \addtocounter{framenumberappendix}{-\value{framenumber}}
   \addtocounter{framenumber}{\value{framenumberappendix}}
}

\begin{document}

\begin{frame}
    \titlepage
\end{frame}

\begin{frame}{Outline}
  \tableofcontents
\end{frame}

\section{Introduction}
\subsection{Load Pull}

\begin{frame}{Why Load Pull?}
    \begin{block}{Non linear measurement system}
        \begin{itemize}
            \item Transistor characterization
        \end{itemize}
    \end{block}
    \begin{block}{Verification}
        \begin{itemize}
            \item Amplifier design
            \item Semiconductor process development
        \end{itemize}
    \end{block}
    \uncover<2>{\qquad\dots by presenting a variable load impedance to the device under test (DUT).}
\end{frame}

\begin{frame}{Load Pull Realization}
    \begin{example}[Passive Load Pull]
        \begin{columns}
            \column{5cm}
                \resizebox{!}{2.5cm}{
                \begin{tikzpicture}
                    \tikzpicturedependsonfile{rfsymbols.tex}
                    \draw node[source] (source) {}
                          node[tuner,right=of source,label=above:{fixed input tuner}] (ituner) {}
                          node[dut,right=of ituner] (dut) {}
                          node[tuner,right=2 of dut,label=above:{output tuner}] (otuner) {}
                          node[match,right=of otuner,label=above:{$Z_0$}] (match) {}
                          node[rground,right=0.3 of match,rotate=90,anchor=center] (ground) {};
                    \draw ($(dut)!.5!(otuner)$) node[coordinate] (plane) {};

                    \draw (source) -- (ituner) -- (dut) -- (otuner) -- (match) -- (ground);

                    \draw [dashed] ($(plane) + (0,2)$) node[anchor=south] {Load Reference Plane} -- ($(plane) - (0,2.5)$);

                    \draw [latex-] ($(plane) + (0,1.5)$) -- ++(-0.5,0) node[anchor=east] {$Z_L$};

                    \draw [-latex] ($(plane) + (0.25,-1)$) node[anchor=west] {$a_2$}-- ++(-0.5,0);
                    \draw [latex-] ($(plane) + (0.25,-1.5)$) node[anchor=west] {$b_2$}-- ++(-0.5,0);
                    \draw [latex-] ($(plane) + (0,-2)$) -- ++(-0.5,0) node[anchor=east] {$\Gamma_L$};

                \end{tikzpicture}
                }
            \column{5cm}
                \[ \Gamma_L = \frac{Z_L-Z_0}{Z_L+Z_0} \]
        \end{columns}
    \end{example}
    \begin{example}[Active Load Pull]
        \begin{columns}
            \column{5cm}
                \resizebox{!}{2.5cm}{
                \begin{tikzpicture}
                    \tikzpicturedependsonfile{rfsymbols.tex}
                    \draw node[source] (source) {}
                          node[tuner,right=of source,label=above:{fixed input tuner}] (ituner) {}
                          node[dut,right=of ituner] (dut) {}
                          node[circulator,right=2 of dut] (circ) {}
                          node[vmatch,right=of circ,label=above:{Attenuator},yshift=1cm] (att) {}
                          node[vphase,right=1.5 of att,label=above:{Phase shift}] (phase) {}
                          node[amplifier,right=of circ,label=above:{Amplifier},yshift=-1cm] (amp) {};

                    \draw ($(dut)!.5!(circ)$) node[coordinate] (plane) {};

                    \draw (source) -- (ituner) -- (dut) -- (circ.A);
                    \draw (circ.B) -- ($(circ.B |- att)!.5!(att)$) node[coordinate] (upper) {} -- (att) -- (phase) -- ++(1,0) |- (amp) -- ($(circ.C |- amp)!.5!(amp)$) node[coordinate] (lower) {} -- (circ.C);

                    \draw [-latex] ($(circ.B) + (-0.2,0.2)$) -- node[sloped,above] {$b_2$} ($(upper) + (-0.2,0.2)$);
                    \draw [latex-] ($(circ.C) + (-0.2,-0.2)$) -- node[sloped,below] {$a_2$} ($(lower) + (-0.2,-0.2)$);

                    \draw [dashed] ($(plane) + (0,2)$) node[anchor=south] {Load Reference Plane} -- ($(plane) - (0,2.5)$);

                    \draw [latex-] ($(plane) + (0,1.5)$) -- ++(-0.5,0) node[anchor=east] {$Z_L$};

                    \draw [-latex] ($(plane) + (0.25,-1)$) node[anchor=west] {$a_2$}-- ++(-0.5,0);
                    \draw [latex-] ($(plane) + (0.25,-1.5)$) node[anchor=west] {$b_2$}-- ++(-0.5,0);
                    \draw [latex-] ($(plane) + (0,-2)$) -- ++(-0.5,0) node[anchor=east] {$\Gamma_L$};
                \end{tikzpicture}
                }
            \column{5cm}
                \[ \Gamma_L = \frac{a_2}{b_2} \]
        \end{columns}
    \end{example}
\end{frame}

\subsection{Limitations}

\begin{frame}{Limitations}
    \begin{block}{Passive Load Pull}
        \begin{itemize}
            \item Limited tuning range
            \item Narrowband
        \end{itemize}
    \end{block}

    \begin{block}{Active Load Pull}
        \begin{itemize}
            \item Stability issues
            \item Narrowband
        \end{itemize}
    \end{block}
\end{frame}


\begin{frame}{Objectives of this Diploma Thesis}
    \begin{block}{Active Load Pull system}
        \begin{itemize}
            \item Baseband
            \item Digital reflection generation
            \item Digital filter to support bandwidths \SI{>= 20}{\mega\hertz}
            \item FPGA based
        \end{itemize}
    \end{block}
\end{frame}


\section{Implementation}

\begin{frame}<beamer>{Outline}
    \tableofcontents[currentsection]
\end{frame}

\begin{frame}{Reflection Generation}
    \begin{block}{Digital Filter}
        \begin{itemize}
            \item Correct frequency response of setup
            \item Synthesize uniformly distributed $\Gamma_L$
        \end{itemize}
    \end{block}
    \begin{block}{Reflection Generation}
        \begin{itemize}
            \item Systematic errors caused by setup
            \item Highly non-linear DUT load dependent $S_{22}$
        \end{itemize}
    \end{block}
    \uncover<2>{\qquad\dots iterative target algorithm}
\end{frame}

\tikzset{incident/.style={color=Set1-3-1}}
\definecolor{incident}{named}{Set1-3-1}
\tikzset{reflect/.style={color=Set1-3-2}}
\definecolor{reflect}{named}{Set1-3-2}
\tikzset{generate/.style={color=Set1-3-3}}
\definecolor{generate}{named}{Set1-3-3}

\begin{frame}{System overview}
    \resizebox{\linewidth}{!}{
    \begin{tikzpicture}
        \pgfdeclarelayer{foreground}
        \pgfsetlayers{background,main,foreground}
        \tikzpicturedependsonfile{rfsymbols.tex}
        \draw node[dut] (dut) {}
              node[dircoupler,right=2 of dut,label=below:dir1] (dirvna) {}
              node[oscilloscope,above=of dirvna.A2,anchor=A1] (oszivna) {}
              node[circulator,right=of dirvna,label=below:circ1] (circ) {}

              node[coordinate,right=of circ,yshift=1.5cm] (uppernode) {}
              node[coordinate,right=of circ,yshift=-1.5cm] (lowernode) {}

              (lowernode) node[amplifier,label=above:amp1] (amp) {}
              node[mixer,right=of amp,label=above:mix3] (upmix) {}
              node[lowpass,right=of upmix,label=above:lp1] (antialias) {}
              node[adc,right=of antialias,label=above:dac1] (dac) {}

              (uppernode -| upmix) node[mixer,label=below:mix1] (downmix) {}
              node[bandpass,right=of downmix,label=below:bp1] (bp) {}
              node[adc,right=of bp,label=below:adc1] (adc) {}
              node[empty,right=of adc,label=below:buffer1] (inbuf) {}
              node[mixer,right=of inbuf] (shift) {}
              node[anchor=west] at (shift.east) {mix2}

              (dac -| inbuf) node[mixer,label=above:mul1,generate] (mul) {}
              node[empty,right=of mul] (outbuf) {}
              node[anchor=north] at (outbuf.south) {buffer2}

              ($(shift)!.5!(outbuf)$) node[allpass,generate] (H) {}
              node[anchor=west] at (H.east) {fir1}

              node[source,above=of downmix.center,scale=0.7] (downsource) {}
              node[anchor=west] at (downsource.east) {lo1}
              node[source,above=of adc.center,scale=0.7] (sample) {}
              node[anchor=west] at (sample.east) {lo2}
              node[source,above=of shift.center,scale=0.7] (shiftsource) {}
              node[anchor=west] at (shiftsource.east) {lo3}
              node[source,below=of upmix.center,scale=0.7] (upsource) {}
              node[anchor=west] at (upsource.east) {lo4}
              node[below=of mul.center] (gamma) {$\Gamma_{L,set}$};

        \draw ($(dut)!.5!(dirvna)$) node[coordinate] (plane) {};

        { [rounded corners=2pt]
            \draw (dut) -- (dirvna) -- (circ.A);
            \draw[incident] [-latex] (circ.B) -- ($(circ.B |- uppernode)!.5!(uppernode)$) node[coordinate] (upper) {} -- (downmix);
            \draw[incident] (dirvna.A2) -- (oszivna.A1);
            \draw[reflect] (dirvna.B2) |- ($(dirvna.B2)!.7!(oszivna.A2)$) node[coordinate] (oszimiddle) {} -| (oszivna.A2);
            \draw[reflect] [-latex] (amp) -- ($(circ.C |- amp)!.5!(lowernode)$) node[coordinate] (lower) {} -- (circ.C);
        }
        { [-latex]
            \draw (downsource) -- (downmix);
            \draw (sample) -- (adc);
            \draw [double] (shiftsource) -- (shift);
            \draw[generate] (gamma) -- (mul);
            \draw (upsource) -- (upmix);
        }
        { [latex-,dashed,every node/.style={font=\footnotesize}]
            \foreach \device in {downsource,sample,shiftsource} {
                \draw (\device) -- ++(0,1) node[anchor=south] {ref};
            }
            \draw ([xshift=0.5cm]oszivna.north) -- ++(0,0.5) node[fill=white,anchor=south] {ref};
            \draw (upsource) -- ++(0,-1) node[anchor=north] {ref};
        }
        { [start chain,every on chain/.style={join=by {-latex,incident}}]
            \chainin (downmix);
            \chainin (bp);
            \chainin (adc);
            \chainin (inbuf);
            \chainin (shift);
            { [every on chain/.style={join=by {double,-latex,incident}}]
                \chainin (H);
                \chainin (outbuf);
                \chainin (mul);
            }
        }
        { [start chain,every on chain/.style={join=by {-latex,reflect}}]
            { [every on chain/.style={join=by {double,-latex,reflect}}]
                \chainin (mul);
                \chainin (dac);
                \chainin (antialias);
                \chainin (upmix);
            }
            \chainin (amp);
        }
        { [on background layer,every path/.style={dotted,decorate,decoration=random steps,segment length=2mm,thick}]
            \draw ($(dirvna.B1)!.5!(circ.A) + (0,4)$) -- ++(0,-8.5) node[coordinate] (leftsplit) {};
            \draw ($(adc.east)!.5!(mul.west) + (0,4)$) -- ++(0,-8.5) node[coordinate] (rightsplit) {};
        }

        \draw (leftsplit) node[anchor=base east] {One Port VNA}
              (leftsplit) node[anchor=base west] {Analog}
              (rightsplit) node[anchor=base west] {Digital}
              (rightsplit) node[anchor=base east] {Analog};

        \draw [dashed] ($(plane) + (0,4)$) node[anchor=south] {Load Reference Plane} -- ($(plane) - (0,4.5)$);

        \draw [latex-] ($(plane) + (0,1.5)$) -- ++(-0.5,0) node[anchor=east] {$Z_L$};

        \draw [-latex,reflect] ($(plane) + (0.25,-1.5)$) node[anchor=west] {$a_2$}-- ++(-0.5,0);
        \draw [latex-,incident] ($(plane) + (0.25,-2)$) node[anchor=west] {$b_2$}-- ++(-0.5,0);
        \draw [latex-] ($(plane) + (0,-2.5)$) -- ++(-0.5,0) node[anchor=east] {$\Gamma_L$};

        {[densely dashdotdotted,latex-latex]
            \draw ($(inbuf.north) + (0,1)$) -- ++(0,1) node [anchor=south] {PC};
            \draw ([xshift=-0.5cm]oszivna.north) -- ++(0,1) node [anchor=south] {PC};
        }
    \end{tikzpicture}
    }
\end{frame}


\subsection{One Port VNA}
\begin{frame}
    \begin{columns}
        \column{5cm}
            \tikzset{external/export next=false}
            \begin{tikzpicture}
                \pgfmathsetseed{23654}
                \pgfdeclarelayer{foreground}
                \pgfsetlayers{background,main,foreground}
                \tikzpicturedependsonfile{rfsymbols.tex}
                \tikzstyle{every node}=[font=\footnotesize]
                \draw node[dut] (dut) {}
                      node[dircoupler,right=2 of dut,label=below:dir1] (dirvna) {}
                      node[oscilloscope,above=of dirvna.A2,anchor=A1] (oszivna) {}
                      node[coordinate,right=1.5em of dirvna] (rest) {}
                      node[coordinate,right=1.5em of rest] (resta) {};

                \draw ($(dut)!.5!(dirvna)$) node[coordinate] (plane) {};

                \draw [dashed] (rest) -- (resta);

                { [rounded corners=2pt]
                    \draw (dut) -- (dirvna) -- (rest);
                    \draw[incident] (dirvna.A2) -- (oszivna.A1);
                    \draw[reflect] (dirvna.B2) |- ($(dirvna.B2)!.7!(oszivna.A2)$) node[coordinate] (oszimiddle) {} -| (oszivna.A2);
                }
                { [latex-,dashed,every node/.style={font=\footnotesize}]
                    \draw ([xshift=0.5cm]oszivna.north) -- ++(0,0.5) node[fill=white,anchor=south] {ref};
                }
                { [on background layer,every path/.style={dotted,decorate,decoration=random steps,segment length=2mm,thick}]
                    \draw ($(rest) + (0,4)$) -- ++(0,-7) node[coordinate] (leftsplit) {};
                }

                \draw (leftsplit) node[anchor=base east] {One Port VNA}
                      (leftsplit) node[anchor=base west] {Analog};

                \draw [-latex,incident] ($(dirvna.A2) + (-0.2,0.1)$) -- node[base left] {$b$} ($(oszivna.A1 |- oszimiddle) - (0.2,0.1)$);
                \begin{pgfonlayer}{foreground}
                    \draw [-latex,reflect] ($(dirvna.B2) + (0.2,0.1)$) -- node[coordinate] (a1) {} ($(oszimiddle -| dirvna.B2) + (0.2,-0.1)$);
                \end{pgfonlayer}
                \draw (a1) node[base right,reflect] {$a$};

                \draw [dashed] ($(plane) + (0,4)$) node[anchor=south] {Load Reference Plane} -- ($(plane) - (0,3)$);

                \draw [latex-] ($(plane) + (0,1.5)$) -- ++(-0.5,0) node[anchor=east] {$Z_L$};

                \draw [-latex,reflect] ($(plane) + (0.25,-1.5)$) node[anchor=west] {$a_2$}-- ++(-0.5,0);
                \draw [latex-,incident] ($(plane) + (0.25,-2)$) node[anchor=west] {$b_2$}-- ++(-0.5,0);
                \draw [latex-] ($(plane) + (0,-2.5)$) -- ++(-0.5,0) node[anchor=east] {$\Gamma_L$};

                {[densely dashdotdotted,latex-latex]
                    \draw ([xshift=-0.5cm]oszivna.north) -- ++(0,1) node [anchor=south] {PC};
                }
            \end{tikzpicture}
        \column{5cm}
            \begin{enumerate}
                \item Acquire \textcolor{incident}{$a_1$}, \textcolor{reflect}{$b_1$}
                \item Extract phase and magnitude
                \tikzset{external/export next=false}
                \item $\Gamma_L = \frac{\textcolor{reflect}{a_2}}{\textcolor{incident}{b_2}} \tikz[remember picture,baseline] \node[anchor=base] (approx) {$\approx$}; \frac{\textcolor{reflect}{a}}{\textcolor{incident}{b}}$
                    \tikzset{external/export next=false}
                    \tikz[overlay,remember picture] \draw [latex-,visible on=2] (approx.south) -- ++(0,-2em) node[below,visible on=2] {Systematic Errors};
            \end{enumerate}
    \end{columns}
\end{frame}


\begin{frame}{Errorbox One Port VNA}
    \begin{columns}
        \column{5cm}
            \tikzset{external/export next=false}
            \begin{tikzpicture}
                \matrix (box)
                [matrix of nodes,%
                 nodes in empty cells,
                 nodes={dspnodeopen},
                 column sep=0.5cm,
                 row sep=2cm,
                 ampersand replacement=\&]
                {
                    |[coordinate]| \& \&[3cm] \& \&[.5cm] |[coordinate]| \\
                    |[coordinate]| \& \& \& \& |[coordinate]| \\
                };
                \draw[-latex] (box-1-1) node[anchor=east] {$a_{1}$} -- (box-1-2);
                \draw[-latex] (box-1-2) -- node[above] {$1$} (box-1-3);
                \draw[-latex] (box-1-3) -- node[above] {$b_{2}$} (box-1-4);

                \draw[latex-] (box-2-1) node[anchor=east] {$b_{1}$} -- (box-2-2);
                \draw[latex-,alert=3] (box-2-2) -- node[above] {$S_{12}$} (box-2-3);
                \draw[latex-] (box-2-3) -- node[above] {$a_{2}$} (box-2-4);

                \draw[-latex,alert=2] (box-1-2) to[bend left=30] node[right] {$S_{11}$} (box-2-2);
                \draw[latex-,alert=4] (box-1-3) to[bend right=30] node[left] {$S_{22}$} (box-2-3);

                \draw[-latex] (box-1-4) to[bend left=30] node[right] {$\Gamma_L$} (box-2-4);

                \draw ($(box-1-2) + (0,0.7cm)$) rectangle ($(box-2-3) - (0,0.7cm)$);
                \draw ($(box-1-4) + (0,0.7cm)$) rectangle ($(box-2-5) - (0,0.7cm)$);

                \draw[dashed] (box-1-2) -- ++(0,1.5cm) node[anchor=south] {Oscilloscope};
                \draw[dashed] (box-1-3) -- ++(0,1.5cm) node[anchor=south] {Load Reference Plane};

                \draw[dashed] (box-2-2) -- ++(0,-1cm);
                \draw[dashed] (box-2-3) -- ++(0,-1cm);

                \draw ($(box-2-4)!.5!(box-2-5) - (0,0.7cm)$) node[anchor=north] {DUT};
                \draw ($(box-2-2)!.5!(box-2-3) - (0,0.7cm)$) node[anchor=north] {Error box};
            \end{tikzpicture}
        \column{5cm}
            \begin{description}
                \item<alert@2>[$S_{11}$] Directivity
                \item<alert@3>[$S_{12}$] Reflection tracking
                \item<alert@4>[$S_{22}$] Source match
            \end{description}
    \end{columns}
\end{frame}

\subsection{Analog Part}
\begin{frame}{Analog Part}
    \begin{columns}
        \column{7cm}
            \resizebox{\linewidth}{!}{
            \begin{tikzpicture}
                \pgfdeclarelayer{foreground}
                \pgfsetlayers{background,main,foreground}
                \tikzpicturedependsonfile{rfsymbols.tex}
                \draw node[coordinate] (dut) {}
                      node[circulator,right=1em of dut,label=below:circ1] (circ) {}
                      node[coordinate,right=of circ,yshift=1.5cm] (uppernode) {}
                      node[coordinate,right=of circ,yshift=-1.5cm] (lowernode) {}

                      (lowernode) node[amplifier,label=above:amp1] (amp) {}
                      node[mixer,right=of amp,label=above:mix3] (upmix) {}
                      node[lowpass,right=of upmix,label=above:lp1] (antialias) {}
                      node[adc,right=of antialias,label=above:dac1] (dac) {}
                      node[coordinate,right=of dac] (outbuf) {}

                      (uppernode -| upmix) node[mixer,label=below:mix1] (downmix) {}
                      node[bandpass,right=of downmix,label=below:bp1] (bp) {}
                      node[adc,right=of bp,label=below:adc1] (adc) {}
                      node[coordinate,right=of adc] (inbuf) {}

                      node[source,above=of downmix.center,scale=0.7] (downsource) {}
                      node[anchor=east] at (downsource.west) {$f_0 - \SI{70}{\mega\hertz}$}
                      node[anchor=west] at (downsource.east) {lo1}
                      node[source,above=of adc.center,scale=0.7] (sample) {}
                      node[anchor=east] at (sample.west) {$\SI{100}{\mega\hertz}$}
                      node[anchor=west] at (sample.east) {lo2}
                      node[source,below=of upmix.center,scale=0.7] (upsource) {}
                      node[anchor=east] at (upsource.west) {$f_0$}
                      node[anchor=west] at (upsource.east) {lo4};

                { [on background layer,every path/.style={dotted,decorate,decoration=random steps,segment length=2mm,thick}]
                    \draw ($(dut) + (0,4)$) -- ++(0,-8.5) node[coordinate] (leftsplit) {};
                    \draw ($(adc.east)!.5!(outbuf.west) + (0,4)$) -- ++(0,-8.5) node[coordinate] (rightsplit) {};
                }
                { [rounded corners=2pt]
                    \draw (dut) -- (circ.A);
                    \draw [-latex,incident] (circ.B) -- ($(circ.B |- uppernode)!.5!(uppernode)$) node[coordinate] (upper) {} -- (downmix);
                    \draw [-latex,reflect] (amp) -- ($(circ.C |- amp)!.5!(lowernode)$) node[coordinate] (lower) {} -- (circ.C);
                }
                { [-latex]
                    \draw (downsource) -- (downmix);
                    \draw (sample) -- (adc);
                    \draw (upsource) -- (upmix);
                }
                { [latex-,dashed,every node/.style={font=\footnotesize}]
                    \foreach \device in {downsource,sample} {
                        \draw (\device) -- ++(0,1) node[anchor=south] {ref};
                    }
                    \draw (upsource) -- ++(0,-1) node[anchor=north] {ref};
                }
                { [start chain,every on chain/.style={join=by {-latex,incident}}]
                    \chainin (downmix);
                    \chainin (bp);
                    \chainin (adc);
                    \chainin (inbuf);
                }
                { [start chain,every on chain/.style={join=by {-latex,reflect}}]
                    { [every on chain/.style={join=by {double,-latex,reflect}}]
                        \chainin (outbuf);
                        \chainin (dac);
                        \chainin (antialias);
                        \chainin (upmix);
                    }
                    \chainin (amp);
                }

                \node [draw,fit=(amp) (dac) (upsource),rounded corners=4pt,inner xsep=6pt,inner ysep=16pt,label={above:Vector Signal Generator}] {};
            \end{tikzpicture}
            }
        \column{4.5cm}
            \begin{itemize}
                \item Circulator for separating waves
                \item Down conversion to \SI{70}{\mega\hertz} IF
                \item \SI{16}{\bit} \SI{100}{\mega\samples\per\second} ADC
                \item Bandpass sampling
            \end{itemize}
    \end{columns}
\end{frame}

\subsection{Digital Part}
\begin{frame}{Digital Part}
    \begin{columns}
        \column{5.5cm}
            \begin{tikzpicture}
                \tikzpicturedependsonfile{rfsymbols.tex}
                \draw node[coordinate,yshift=-1.5cm,label=left:$a_2$] (dac) {}

                      node[coordinate,yshift=1.5cm,label=left:$b_2$] (adc) {}
                      node[empty,right=of adc,label=below:buffer1] (inbuf) {}
                      node[mixer,right=of inbuf] (shift) {}
                      node[anchor=west] at (shift.east) {mix2}

                      (dac -| inbuf) node[mixer,label=above:mul1,generate] (mul) {}
                      node[empty,right=of mul] (outbuf) {}
                      node[anchor=west] at (outbuf.east) {buffer2}

                      ($(shift)!.5!(outbuf)$) node[allpass,generate] (H) {}
                      node[anchor=west] at (H.east) {fir1}

                      node[source,above=of shift.center,scale=0.7] (shiftsource) {}
                      node[anchor=east] at (shiftsource.west) {$\SI{30}{\mega\hertz}$}
                      node[anchor=west] at (shiftsource.east) {lo3}
                      node[below=of mul.center,fill=white] (gamma) {$\Gamma_{L,set}$};

                { [on background layer,every path/.style={dotted,decorate,decoration=random steps,segment length=2mm,thick}]
                    \draw ($(adc.east)!.5!(mul.west) + (0,4)$) -- ++(0,-7) node[coordinate] (rightsplit) {};
                }
                { [-latex]
                    \draw[double] (shiftsource) -- (shift);
                    \draw[double,generate] (gamma) -- (mul);
                }
                { [latex-,dashed,every node/.style={font=\footnotesize}]
                    \foreach \device in {shiftsource} {
                        \draw (\device) -- ++(0,1) node[anchor=south] {ref};
                    }
                }
                { [start chain,every on chain/.style={join=by {-latex,incident}}]
                    \chainin (adc);
                    \chainin (inbuf);
                    \chainin (shift);
                    { [every on chain/.style={join=by {double,-latex,incident}}]
                        \chainin (H);
                        \chainin (outbuf);
                        \chainin (mul);
                    }
                }
                \draw[double,-latex,reflect] (mul) -- (dac);
            \end{tikzpicture}
        \column{7cm}
            \begin{itemize}
                \item Down conversion to Baseband
                \item Fully configurable filter \device{fir1} implemented with circular convolution
                \item Multiplier for reflection generation
                \item Implemented in FPGA
            \end{itemize}
    \end{columns}
\end{frame}

\begin{frame}{Iterative Target Algorithm}
    \begin{enumerate}
        \item Arbitrary start point
        \item Measure $\Gamma_L$
        \item If $\abs{\Gamma_L - \Gamma_{L,target}} < accuracy$ \Rightarrow done
        \item Scale $\Gamma_{L,set}$ according to $\frac{\Gamma_{L,target}}{\Gamma_L}$
        \item Repeat from step 2
    \end{enumerate}
\end{frame}


\section{Results}

\subsection{Reflection Generation}

\begin{frame}[fragile]{Target algorithm}
    \begin{tikzpicture}[
        spy/.style={%
            draw,green,
            line width=0.5pt,
            circle,inner sep=0pt,
        },
        every axis/.style={font=\footnotesize},
        ]
        \def\spyviewersize{3cm}
        \def\spyonclipreduce{0.5pt}
        \def\spyfactorI{10}

        \def\pic#1#2{
            \begin{smithchart}[width=7cm,clip=false#1]
                \addplot[blue,is smithchart cs] file {testdata/filter/1.0,0/trajectory10.data};
                \addplot[purple,is smithchart cs,only marks,mark=x#2] file {testdata/filter/1.0,0/trajectory10.data};
                \draw (cartesian cs:1,0) node[coordinate] (a) {}
                      (cartesian cs:-0.4,0.4) node[coordinate] (b) {};
            \end{smithchart}
        }
        \pic{}{}
        \coordinate (spy-on 1) at (a);
        \coordinate (spy-in 1) at (b);

        \node[spy,ultra thick,circular drop shadow,minimum size=\spyviewersize,fill=white,label={[inner sep=2pt,yshift=-5pt,fill=white,font=\small]below:\spyfactorI{}x magnification}] (spy-in node 1) at (spy-in 1) {};
        \begin{scope}
            \clip (spy-in 1) circle (0.5*\spyviewersize-\spyonclipreduce);
            \pgfmathsetmacro\sI{1/\spyfactorI}
            \begin{scope}[
                shift={($\sI*(spy-in 1)-\sI*(spy-on 1)$)},
                scale around={\spyfactorI:(spy-on 1)}
            ]
            \pic{,every axis plot post/.append style={line width=0.07pt},every axis/.append style={line width=0.07pt,grid style={line width=0.07pt}}}{,mark size=0.35pt}
            \end{scope}
        \end{scope}

    \end{tikzpicture}
\end{frame}


\begin{frame}{Target algorithm performance}
    \begin{tikzpicture}
        \begin{axis}[
                ybar interval,
                ylabel={percentage of invocations},
                xlabel={number of iterations},
                x filter/.expression={x-1}, % remove the start point
                ymin = 0
            ]
            \addplot[blue,fill=blue!10,hist={bins=7,data min=3,data max=10,density=true}] table[y index=0] {testdata/trajectories/performance.data};
        \end{axis}
    \end{tikzpicture}
\end{frame}

\subsection{Filter performance}

\begin{frame}{Calibrated Filter, Uncalibrated $\Gamma_{L,set}$}
    \begin{columns}
        \column{0.5\linewidth}
            \begin{tikzpicture}[every axis/.style={font=\tiny}]
                \begin{smithchart}[width=\linewidth,clip=false]
                    \foreach \i in {1,...,11}{
                        \foreach \j in {1,...,11}{
                            \addplot[blue,is smithchart cs] file {testdata/filter/0.5,135/\i,\j.data};
                        }
                    }
                    \addplot[red,is smithchart cs,mark=*,only marks] coordinates {(-0.3536,0.3536)};
                \end{smithchart}
            \end{tikzpicture}
        \column{0.5\linewidth}
            \begin{tikzpicture}[every axis/.style={font=\tiny}]
                \begin{smithchart}[width=\linewidth,clip=false]
                    \foreach \i in {1,...,11}{
                        \foreach \j in {1,...,11}{
                            \addplot[blue,is smithchart cs] file {testdata/filter/0.5,-45/\i,\j.data};
                        }
                    }
                    \addplot[red,is smithchart cs,mark=*,only marks] coordinates {(0.3536,-0.3536)};
                \end{smithchart}
            \end{tikzpicture}
    \end{columns}
\end{frame}

\section*{Summary}

\begin{frame}{Summary}
    \begin{itemize}
        \item It works
    \end{itemize}
\end{frame}

\appendix
\backupbegin
\section<presentation>*{\appendixname}

\begin{frame}{Overlap Add Algorithm}
\begin{figure}[htb]
    \centering
    \begin{tikzpicture}
        \begin{scope}[shift={(0,13em)}]
            \draw [decorate,decoration={brace},yshift=2pt] (0,4.1em) -- (5,4.1em) node[midway,yshift=8pt] {$n$};
            \draw [decorate,decoration={brace},yshift=2pt] (0,2.8em) -- (3,2.8em) node[midway,yshift=8pt] {$n_{fft}$};
            \draw [decorate,decoration={brace},yshift=2pt] (0,1.5em) -- (2,1.5em) node[midway,yshift=8pt] {$L$};
            \draw (0,0.75em) node[anchor=east] {$x[n]$};
            \draw (0,0) rectangle (5,1.5em);
            \draw (5,0.75em) node[anchor=west] (zeros) {0000};
            \draw [dashed] (5,0) rectangle (6,1.5em) (2,0) -- (2,1.5em) (4,0) -- (4,1.5em);
        \end{scope}
        \begin{scope}[shift={(0,9em)}]
            \draw (0,0.75em) node[anchor=east] {$y_0[n]$};
            \draw (0,0) rectangle (2,1.5em);
            \draw [fill=black!30] (2,0) rectangle (3,1.5em);
            \draw (2.5,0) node[coordinate] (y0b) {};
            \draw (0.5,0) node[coordinate] (y2b) {};
        \end{scope}
        \begin{scope}[shift={(0,6em)}]
            \draw (0,0.75em) node[anchor=east] {$y_1[n]$};
            \draw (2,0) rectangle (4,1.5em);
            \draw [fill=black!30] (4,0) rectangle (5,1.5em);
            \draw (2.5,1.5em) node[coordinate] (y1t) {};
            \draw (4.5,0) node[coordinate] (y1b) {};
        \end{scope}
        \begin{scope}[shift={(0,3em)}]
            \draw (0,0.75em) node[anchor=east] {$y_2[n]$};
            \draw (4,0) rectangle (6,1.5em);
            \draw [fill=black!30] (6,0) rectangle (7,1.5em);
            \draw [fill=red!30] (0,0) rectangle (1,1.5em);
            \draw (1,0.75em) node[coordinate] (circto) {};
            \draw (4.5,1.5em) node[coordinate] (y2t) {};
            \draw (0.5,1.5em) node[coordinate] (ynt) {};
        \end{scope}
        \draw (0,0.75em) node[anchor=east] {$y[n]$};
        \draw (0,0) rectangle (5,1.5em);
        \draw [dashed,color=red] (5,0) rectangle (6,1.5em);
        \draw [dotted] (6,1.5em) rectangle (7,0em);
        \draw [latex-,color=red] (circto) parabola (5.5,1.5em);

        \draw ($(y0b)!.5!(y1t)$) node {$+$};
        \draw ($(y1b)!.5!(y2t)$) node {$+$};
        \draw ($(y2b)!.5!(ynt)$) node {$+$};
        \draw [dotted]
              (0,1.5em) -- (0,13em)
              (1,1.5em) -- (1,9em)
              (2,1.5em) -- (2,9em)
              (3,7.5em) -- (3,9em)
              (3,1.5em) -- (3,6em)
              (4,1.5em) -- (4,6em)
              (5,1.5em) -- (5,3em)
              (5,4.5em) -- (5,6em)
              (7,1.5em) -- (7,3em)
              (2,13em) -- (3,10.5em)
              (4,13em) -- (5,10.5em) -- (5,7.5em)
              (6,13em) -- (7,10.5em) -- (7,4.5em);
    \end{tikzpicture}
\end{figure}
\end{frame}

\begin{frame}{FPGA Design}
    \resizebox{\linewidth}{!}{
    \begin{tikzpicture}[every node/.style={minimum width=5em},latex-latex]
        \matrix (peripherals)[matrix of nodes,column sep=1em,row sep=0.2em,nodes={draw,anchor=center},ampersand replacement=\&]
        {
            DRAM \& \shortstack{DRAM\\Controller} \\
            Ethernet \& \shortstack{Ethernet\\Controller} \\
            RS232 \& \shortstack{RS232\\Interface} \\
            Storage \& SysAce \\
            \shortstack{LEDS\\Switches} \& GPIO \\
        };
        \node[draw,minimum size=5em,above right=0em of peripherals] (cpu) {CPU};
        \draw (peripherals-1-1) -- (peripherals-1-2);
        \draw (peripherals-1-2) -| ([xshift=-2.5em]cpu);
        \draw ([yshift=1em]peripherals-2-2) -| ([xshift=-1.5em]cpu);
        \foreach \i in {2,...,5}
        {
            \draw (peripherals-\i-1) -- (peripherals-\i-2);
            \draw (peripherals-\i-2) -- (peripherals-\i-2 -| cpu);
        }
        \draw[ultra thick,-] (peripherals-5-2 -| cpu) ++(0,-1em) node[below] (plb) {PLB} -- (cpu);
        \node[draw] at ($(peripherals-5-2)!2!(peripherals-5-2 -| cpu)$) (bram) {RAM};
        \draw (peripherals-5-2 -| cpu) -- (bram);
        \node[draw] at ($(peripherals-2-2)!2!(peripherals-2-2 -| cpu)$) (pint) {\shortstack{Processor\\Interface}};
        \draw (peripherals-2-2 -| cpu) -- (pint);
        \matrix (internal)[matrix of nodes,column sep=1em,row sep=0.2em,nodes={draw,anchor=center},right=of pint]
        {
            inbuf \\
            core \\
            outbuf \\
            auto \\
        };
        \node[draw,right=1.5em of internal-3-1] (digiq) {Digital I/Q};
        \node[draw,right=1.5em of internal-1-1] (adc) {ADC};
        \node[coordinate] at ($(pint.east) + (2em,0)$) (l) {};
        \foreach \i in {1,...,4}
        {
            \draw (pint.east) -- (l) |- (internal-\i-1);
        };
        \draw (internal-1-1) -- (adc);
        \draw (internal-3-1) -- (digiq);
        \node[draw,fit=(internal-1-1) (internal-4-1) (l),inner xsep=0.5em,label=main] (main) {};
        \node[draw,fit=(cpu) (peripherals-5-2) (plb) (main),inner xsep=0.5em,label=top] (fpga) {};

    \end{tikzpicture}
    }
\end{frame}

\begin{frame}{Phase drift of $\Gamma_L$}
    \begin{tikzpicture}
        \begin{axis}[
                ylabel={angle},
                y unit={\degree},
                xlabel={time},
                x unit={\minute}, %change xbase
                width=.95\linewidth,
                x filter/.expression={x/60},
                xmin=0,
                xmax=1000,
                height=7cm
            ]
            \addplot[blue] table {testdata/phase/single.data};
        \end{axis}
    \end{tikzpicture}
\end{frame}
\backupend
\end{document}

