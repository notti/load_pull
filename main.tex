\documentclass[12pt,a4paper,parskip=full,abstract=true]{scrreprt}
\KOMAoption{bibliography}{totoc}
\KOMAoption{listof}{totoc}

\usepackage[ngerman,english]{babel}
\usepackage[utf8]{inputenc}

%drawings

\usepackage[pdftex]{graphicx}
\graphicspath{{graphics/}}
\usepackage{tikz}
\usepackage{circuitikz}
\usetikzlibrary{positioning,dsp,chains,fit,scopes,calc,backgrounds,arrows,decorations.pathmorphing,bending,arrows.meta}

\include{rfsymbols}

%units

\usepackage[binary-units,retain-explicit-plus]{siunitx}
\DeclareSIUnit \belm {Bm}
\DeclareSIUnit \belfs {BFS}
\DeclareSIUnit \samples {S}
\sisetup{per-mode = symbol}

%plots

\usepackage{pgfplots}
\pgfplotsset{compat=1.12}
\pgfplotsset{every axis plot/.append style={smooth},every axis/.append style={grid=major,legend style={font=\footnotesize}}} 
\usepgfplotslibrary{smithchart}
\usepgfplotslibrary{units}
\usepgfplotslibrary{fillbetween}
\pgfplotsset{unit code/.code 2 args={\si{#1#2}}}

\usepgfplotslibrary{external}
\tikzsetexternalprefix{figures/}
\tikzexternalize[mode=list and make]

%math

\usepackage[cmex10]{amsmath}
\usepackage{amssymb}
\usepackage{gensymb}

%source

\usepackage{listings}
\lstset{language=Python,numbers=left,numberstyle=\tiny,stepnumber=5,numbersep=5pt,frame=single,
breaklines=true,postbreak=\raisebox{0ex}[0ex][0ex]{\ensuremath{\color{red}\hookrightarrow\space}},
captionpos=b,escapeinside={(*}{*)}}

%stuff

\usepackage{url}
\usepackage{tocloft} %table of contents modification
\usepackage{subcaption} %subfigures
\usepackage[noabbrev]{cleveref}
\usepackage{placeins} % keep floats in check (=sections where they belong)
\usepackage{booktabs} % nicer tables


\usepackage[colorlinks,hyperindex,plainpages=false,
pdftitle={FPGA-based Load-Pull Measurement System},
pdfauthor={Gernot Vormayr},
pdfsubject={Diploma thesis},
pdfpagelabels %,hidelinks
]{hyperref}

% lots of acronyms
\usepackage[acronym]{glossaries}

\newacronym{fpga}{FPGA}{field programmable gate array}
\newacronym{iq}{IQ}{in-phase/quadrature-phase}
\newacronym[longplural={general-purpose inputs/outputs}]{gpio}{GPIO}{general-purpose input/output}
\newacronym{fir}{FIR}{finite impulse response}
\newacronym{gui}{GUI}{graphical user interface}
\newacronym{ui}{UI}{user interface}
\newacronym{rf}{RF}{radio frequency}
\newacronym{if}{IF}{intermediate frequency}
\newacronym{ram}{RAM}{random access memory}
\makeglossaries


\begin{document}
\begin{titlepage}
    \enlargethispage{1cm}
    \centering
    \vspace*{5cm}
    {\Huge \textbf{Diploma thesis}}\\
    \vspace*{1cm}
    {\Large \Gls{fpga}-based Load-Pull Measurement System}

    \vspace*{2cm}
    {\large Gernot ~\textsc{Vormayr} \\ 0425210 \\ } ~\\ 

    \vspace*{2cm}
    {\today } ~\\ 

    \vfill
    {Supervisors} ~\\\vspace*{0.1cm}
    {Ass.Prof. Dipl.-Ing. Dr.techn. \large Holger ~\textsc{Arthaber}} ~\\
    {Univ.Ass. Dipl.-Ing. Dr.techn. \large Thomas ~\textsc{Faseth}}
    \vspace*{2cm}

    \rule{\linewidth}{0.4pt}
    \begin{minipage}[t]{0.55\linewidth}
        \flushleft
        \begin{large}
            EMCE - Institute of Electrodynamics, Microwave and Circuit Engineering
        \end{large}\\
        Vienna University of Technology
    \end{minipage}
    \hfill
    \begin{minipage}[t]{0.27\linewidth}
        \flushright
        Gusshausstrasse 25\\
        1040 Vienna\\
        www.emce.tuwien.ac.at
    \end{minipage}
    \vspace*{-3pt}
    \rule{\linewidth}{0.4pt}
    \clearpage
\end{titlepage}

\begin{abstract}
    %TODO
    Todo
\end{abstract}

\begin{otherlanguage}{ngerman}
\begin{abstract}
    %TODO
    Todo
\end{abstract}
\end{otherlanguage}

\renewcommand{\abstractname}{Acknowledgements}
\begin{abstract}
Thanks to the team of the microwave lab even if they only have one microwave oven.
\end{abstract}

\tableofcontents

\chapter{Introduction}
\chapter{Load-Pull Measurement System}
\section{One Port Vector Network Analyzer}
\section{Reflection Generation}
\chapter{FPGA Implementation}
\section{Data Acquisition}
\section{Overlap Add}
\section{SMBV Interface}
\section{Processor Interface}
\chapter{Software Implementation}
\section{Kernel Module}
\section{Network Server and Web-Interface}
\section{Matlab Driver}
\chapter{Verification of the Measurement System}
\begin{tikzpicture}[node distance=0.6]
    \tikzstyle{every node}=[font=\footnotesize]
    \draw node[dut] (dut) {}
          node[dircoupler,right=1 of dut] (dirvna) {}
          node[dircouplera,right=of dirvna] (dircirc) {}
          node[attenuator,right=of dircirc,label=below:\scriptsize\SI{10}{\deci\bel}] (attcirc) {}
          node[vectorgenerator,right=of attcirc,anchor=out,label=below:\scriptsize\SI{900}{\mega\hertz}] (gen) {}

          node[lowpass,above=of attcirc,label=below:\scriptsize\SI{81}{\mega\hertz}] (alias) {}
          node[mixer,rotate=180,left=of alias,anchor=in,scale=0.5] (mixer) {}
          node[adc,right=of alias] (adc) {}
          node[generator,above=of mixer.in 2] (lo) {}
          node[rotate=90,anchor=north] at (lo.east) {\scriptsize\SI{830}{\mega\hertz}}

          node[generator,above=of adc] (sample) {}
          node[rotate=90,anchor=north] at (sample.east) {\scriptsize\SI{100}{\mega\hertz}}

          node[oscilloscope,above=of dirvna.A2,anchor=A1] (oszivna) {}
          
          node[mixer,right=1 of gen.in,scale=0.4,rotate=180,anchor=out] (mult) {}
          (mult |- adc) node[mixer,scale=0.4] (iqdemod) {}
          ($(mult)!.5!(iqdemod)$) node[allpass,rotate=-90,scale=0.7] (filter) {}
          node[rotate=90,anchor=north] at (filter.north) {H}
          
          node[vsourcesinshape,scale=.5,rotate=90,right=of iqdemod.out,anchor=center] (diglo) {}
          node[rotate=90,anchor=north] at (diglo.south) {\scriptsize\SI{30}{\mega\hertz}}
          (mult -| diglo) node (gamma) {$\Gamma$};

    \draw [rounded corners=2pt]
          (dut.B) -- (dirvna.A1)
          (dirvna.B1) -- (dircirc.A1)
          (dircirc.B1) -- (attcirc.A)
          (attcirc.B) -- (gen.out)

          (dirvna.A2) -- (oszivna.A1)
          (dirvna.B2) |- ($(dirvna.B2)!.5!(oszivna.A2)$) -| (oszivna.A2)

          (dircirc.A2) |- (mixer.out)
          (mixer.in) -- (alias.A)
          (alias.B) -- (adc.A)

          (mixer.in 2) -- (lo)

          (sample) -- (adc) -- (iqdemod.in)
          (iqdemod.in 2) -- (filter) -- (mult.in 2)
          (mult.out) -- (gen.in)
          
          (diglo) -- (iqdemod.out)
          (gamma) -- (mult.in);

    \begin{scope}[rounded corners=2pt]
        \draw [<-]
        (sample.north) |- ($(sample.north) + (5pt,0.4)$) node[coordinate] (merge) {} -| ($(gen.north west)!.85!(gen.north east)$) node[coordinate] (refgen) {};
        \draw [->] (merge) -| (lo.north);
        \draw [->] (merge) -| (oszivna.north);
    \end{scope}

    \draw ($(refgen |- oszivna.north)!.5!(oszivna.north)$) node[coordinate] (refa) {}
          (refa |- merge) node[anchor=south] {\scriptsize\SI{10}{\mega\hertz} Reference clock};

    \node[draw,fit=(iqdemod) (filter) (mult) (diglo),rounded corners=4pt,inner xsep=12pt,inner ysep=8pt,label=above:FPGA] {};

\end{tikzpicture}
\section{One Port Vector Network Analyzer}
\section{Reflection Measurements}
\begin{tikzpicture}
    \begin{smithchart}[width=7cm,clip=false]
        \foreach \i in {1,...,11}{
            \foreach \j in {1,...,11}{
                \addplot[blue,is smithchart cs] file {testdata/filter/-1+0i/\i,\j.data};
            }
        }
        \addplot[red,is smithchart cs,mark=*,only marks] coordinates {(-1,0)};
    \end{smithchart}
\end{tikzpicture}\\
\begin{tikzpicture}
    \begin{smithchart}[width=7cm,clip=false]
        \foreach \i in {1,...,11}{
            \foreach \j in {1,...,11}{
                \addplot[blue,is smithchart cs] file {testdata/filter/+1+0i/\i,\j.data};
            }
        }
        \addplot[red,is smithchart cs,mark=*,only marks] coordinates {(+1,0)};
    \end{smithchart}
\end{tikzpicture}\\
\begin{tikzpicture}
    \begin{smithchart}[width=7cm,clip=false]
        \foreach \i in {1,...,11}{
            \foreach \j in {1,...,11}{
                \addplot[blue,is smithchart cs] file {testdata/filter/mean1/\i,\j.data};
            }
        }
        \addplot[red,is smithchart cs,mark=*,only marks] coordinates {(-1,0) (+1,0)};
    \end{smithchart}
\end{tikzpicture}

\section{Phase Drift}
\begin{tikzpicture}
    \begin{axis}[
            ylabel={angle},
            xlabel={seconds},
            x unit={\s},
            width=\linewidth
        ]
        \addplot[blue] table {testdata/phase/single.data};
    \end{axis}
\end{tikzpicture}

\pgfplotstableread{testdata/phase/all.data}\phaseall

\begin{tikzpicture}
    \begin{axis}[
            ylabel={angle},
            xlabel={seconds},
            x unit={\s},
            width=\linewidth
        ]
        \addplot[blue] table {\phaseall};
        \addplot[green] table[x index=0,y index=2] {\phaseall};
        \addplot[red] table[y index=3] {\phaseall};
        \addplot[black] table[y index=4] {\phaseall};
    \end{axis}
\end{tikzpicture}
\chapter{Conclusions and Outlook}

\begin{appendix}
    \chapter{Hardware Reference}
    \section{Physical Overview}
    \section{Memory Map \& Register Assignment}
    \chapter{Software Reference}
    \section{Kernel Module Usage}
    \section{Protocols}
    \section{Matlab Classes}
    \section{Usage Examples}
    \chapter{Build Instructions}
    \section{Hardware}
    \section{Software}

    \printglossary[type=\acronymtype]

    \listoffigures

    \bibliographystyle{IEEEtran}
    \bibliography{IEEEabrv,literature}

\begin{otherlanguage}{ngerman}
    \chapter*{Code of Conduct}
    Hiermit erkl\"are ich, dass die vorliegende Arbeit ohne unzul\"assige Hilfe Dritter und ohne Benutzung
    anderer als der angegebenen Hilfsmittel angefertigt wurde. Die aus anderen Quellen oder indirekt
    \"ubernommenen Daten und Konzepte sind unter Angabe der Quelle gekennzeichnet.
    Die Arbeit wurde bisher weder im In- noch im Ausland in gleicher oder in \"ahnlicher Form in anderen
    Pr\"ufungsverfahren vorgelegt.

    \par\noindent\makebox[7cm]{\hrulefill}      \hfill\makebox[5cm]{\hrulefill}%
    \par\noindent\makebox[7cm][l]{Unterschrift} \hfill\makebox[5cm][l]{Datum}%
\end{otherlanguage}

    \end{appendix}
\end{document}

