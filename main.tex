\documentclass[12pt,a4paper,twoside,parskip=full]{scrreprt}
\usepackage{tikz}
\usepackage{circuitikz}
\usepackage{gensymb}
\usetikzlibrary{positioning,dsp,chains,fit,scopes,calc,backgrounds,arrows,decorations.pathmorphing,bending,arrows.meta}
\usepackage{siunitx}
\DeclareSIUnit \belm {Bm}
\DeclareSIUnit \belfs {BFS}
\DeclareSIUnit \samples {S}
\sisetup{per-mode = symbol}
\usepackage{pgfplots}
\pgfplotsset{compat=1.12}
\pgfplotsset{every axis plot/.append style={smooth},every axis/.append style={grid=major,legend style={font=\footnotesize}}} 
\usepgfplotslibrary{smithchart}
\usepgfplotslibrary{units}
\usepgfplotslibrary{fillbetween}
\pgfplotsset{unit code/.code 2 args={\si{#1#2}}}

\usepgfplotslibrary{external}
\tikzsetexternalprefix{figures/}
\tikzexternalize

\include{rfsymbols}

\usepackage[colorlinks,hyperindex,plainpages=false,
pdftitle={FPGA-based Load-Pull Measurement System},
pdfauthor={Gernot Vormayr},
pdfsubject={Diploma thesis},
pdfpagelabels %,hidelinks
]{hyperref}

\author{Gernot Vormayr}
\title{FPGA-based Load-Pull Measurement System}

\begin{document}

\maketitle
\tableofcontents

\chapter{Introduction}
\chapter{Load-Pull Measurement System}
\section{One Port Vector Network Analyzer}
\section{Reflection Generation}
\chapter{FPGA Implementation}
\section{Data Acquisition}
\section{Overlap Add}
\section{SMBV Interface}
\section{Processor Interface}
\chapter{Software Implementation}
\section{Kernel Module}
\section{Network Server and Web-Interface}
\section{Matlab Driver}
\chapter{Verification of the Measurement System}
\begin{tikzpicture}[node distance=0.6]
    \tikzstyle{every node}=[font=\footnotesize]
    \draw node[dut] (dut) {}
          node[dircoupler,right=1 of dut] (dirvna) {}
          node[dircouplera,right=of dirvna] (dircirc) {}
          node[attenuator,right=of dircirc,label=below:\scriptsize\SI{10}{\deci\bel}] (attcirc) {}
          node[vectorgenerator,right=of attcirc,anchor=out,label=below:\scriptsize\SI{900}{\mega\hertz}] (gen) {}

          node[lowpass,above=of attcirc,label=below:\scriptsize\SI{81}{\mega\hertz}] (alias) {}
          node[mixer,rotate=180,left=of alias,anchor=in,scale=0.5] (mixer) {}
          node[adc,right=of alias] (adc) {}
          node[generator,above=of mixer.in 2] (lo) {}
          node[rotate=90,anchor=north] at (lo.east) {\scriptsize\SI{830}{\mega\hertz}}

          node[generator,above=of adc] (sample) {}
          node[rotate=90,anchor=north] at (sample.east) {\scriptsize\SI{100}{\mega\hertz}}

          node[oscilloscope,above=of dirvna.A2,anchor=A1] (oszivna) {}
          
          node[mixer,right=1 of gen.in,scale=0.4,rotate=180,anchor=out] (mult) {}
          (mult |- adc) node[mixer,scale=0.4] (iqdemod) {}
          ($(mult)!.5!(iqdemod)$) node[allpass,rotate=-90,scale=0.7] (filter) {}
          node[rotate=90,anchor=north] at (filter.north) {H}
          
          node[vsourcesinshape,scale=.5,rotate=90,right=of iqdemod.out,anchor=center] (diglo) {}
          node[rotate=90,anchor=north] at (diglo.south) {\scriptsize\SI{30}{\mega\hertz}}
          (mult -| diglo) node (gamma) {$\Gamma$};

    \draw [rounded corners=2pt]
          (dut.B) -- (dirvna.A1)
          (dirvna.B1) -- (dircirc.A1)
          (dircirc.B1) -- (attcirc.A)
          (attcirc.B) -- (gen.out)

          (dirvna.A2) -- (oszivna.A1)
          (dirvna.B2) |- ($(dirvna.B2)!.5!(oszivna.A2)$) -| (oszivna.A2)

          (dircirc.A2) |- (mixer.out)
          (mixer.in) -- (alias.A)
          (alias.B) -- (adc.A)

          (mixer.in 2) -- (lo)

          (sample) -- (adc) -- (iqdemod.in)
          (iqdemod.in 2) -- (filter) -- (mult.in 2)
          (mult.out) -- (gen.in)
          
          (diglo) -- (iqdemod.out)
          (gamma) -- (mult.in);

    \begin{scope}[rounded corners=2pt]
        \draw [<-]
        (sample.north) |- ($(sample.north) + (5pt,0.4)$) node[coordinate] (merge) {} -| ($(gen.north west)!.85!(gen.north east)$) node[coordinate] (refgen) {};
        \draw [->] (merge) -| (lo.north);
        \draw [->] (merge) -| (oszivna.north);
    \end{scope}

    \draw ($(refgen |- oszivna.north)!.5!(oszivna.north)$) node[coordinate] (refa) {}
          (refa |- merge) node[anchor=south] {\scriptsize\SI{10}{\mega\hertz} Reference clock};

    \node[draw,fit=(iqdemod) (filter) (mult) (diglo),rounded corners=4pt,inner xsep=12pt,inner ysep=8pt,label=above:FPGA] {};

\end{tikzpicture}
\section{One Port Vector Network Analyzer}
\section{Reflection Measurements}
\begin{tikzpicture}
    \begin{smithchart}[width=7cm,clip=false]
        \foreach \i in {1,...,11}{
            \foreach \j in {1,...,11}{
                \addplot[blue,is smithchart cs] file {testdata/filter/-1+0i/\i,\j};
            }
        }
        \addplot[red,is smithchart cs,mark=*,only marks] coordinates {(-1,0)};
    \end{smithchart}
\end{tikzpicture}\\
\begin{tikzpicture}
    \begin{smithchart}[width=7cm,clip=false]
        \foreach \i in {1,...,11}{
            \foreach \j in {1,...,11}{
                \addplot[blue,is smithchart cs] file {testdata/filter/+1+0i/\i,\j};
            }
        }
        \addplot[red,is smithchart cs,mark=*,only marks] coordinates {(+1,0)};
    \end{smithchart}
\end{tikzpicture}\\
\begin{tikzpicture}
    \begin{smithchart}[width=7cm,clip=false]
        \foreach \i in {1,...,11}{
            \foreach \j in {1,...,11}{
                \addplot[blue,is smithchart cs] file {testdata/filter/mean1/\i,\j};
            }
        }
        \addplot[red,is smithchart cs,mark=*,only marks] coordinates {(-1,0) (+1,0)};
    \end{smithchart}
\end{tikzpicture}

\section{Phase Drift}
\begin{tikzpicture}
    \begin{axis}[
            ylabel={angle},
            xlabel={seconds},
            x unit={\s},
            width=\linewidth
        ]
        \addplot[blue] table {testdata/phase/single};
    \end{axis}
\end{tikzpicture}

\pgfplotstableread{testdata/phase/all}\phaseall

\begin{tikzpicture}
    \begin{axis}[
            ylabel={angle},
            xlabel={seconds},
            x unit={\s},
            width=\linewidth
        ]
        \addplot[blue] table {\phaseall};
        \addplot[green] table[x index=0,y index=2] {\phaseall};
        \addplot[red] table[y index=3] {\phaseall};
        \addplot[black] table[y index=4] {\phaseall};
    \end{axis}
\end{tikzpicture}
\chapter{Conclusions and Outlook}

\begin{appendix}
    \chapter{Hardware Reference}
    \section{Physical Overview}
    \section{Memory Map \& Register Assignment}
    \chapter{Software Reference}
    \section{Kernel Module Usage}
    \section{Protocols}
    \section{Matlab Classes}
    \section{Usage Examples}
    \chapter{Build Instructions}
    \section{Hardware}
    \section{Software}
\end{appendix}

\end{document}


